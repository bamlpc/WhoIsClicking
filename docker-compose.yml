version: '3.7'

services:

  frontend:
    build:
      context: ./frontend
    container_name: frontend
    restart: on-failure
    depends_on:
      - backend
    command: npm start
    stdin_open: true
    tty: true
    volumes:
      - ./frontend/src:/usr/app/src
    ports:
      - '3000:3000'
    networks:
      wic_network:
        aliases: 
          - frontend_ip

  backend:
    build:
      context: ./backend
    restart: on-failure
    depends_on:
      mongodb:
        condition: service_healthy
    container_name: backend
    command: denon start
    init: true
    environment:
      - URL=${URL}
      - PORT=${PORT}
      - DB_NAME=${DB_NAME}
      - MONGODB_URL=${MONGODB_URL}
      - MONGODB_USER=${MONGODB_USER}
      - MONGODB_PASS=${MONGODB_PASS}
      - BACKEND_VERSION=${BACKEND_VERSION}
    volumes:
      - ./backend/mod.ts:/usr/app/mod.ts
      - ./backend/src:/usr/app/src
    networks:
      wic_network:
        aliases: 
          - backend_ip

  mongodb:
    build:
      context: ./mongodb
    restart: always
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: $MONGO_ROOT_USER
      MONGO_INITDB_ROOT_PASSWORD: $MONGO_ROOT_PASS
      MONGO_INITDB_DATABASE: $DB_NAME
      MONGO_INITDB_USERNAME: $MONGODB_USER
      MONGO_INITDB_PASSWORD: $MONGODB_PASS
    volumes:
      - ./mongodb/data:/data/db
      - ./mongodb/log:/var/log/mongodb/
      - ./mongodb/mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh:ro
    networks:
      wic_network:
        aliases: 
          - mongodb_ip
    healthcheck:
      test: ["CMD-SHELL", "mongo --host mongodb_ip --eval 'db.getSiblingDB(\"$DB_NAME\").runCommand(\"ping\")'"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s

  jenkins:
    image: jenkins/jenkins:2.350-alpine
    #restart: unless-stopped
    container_name: jenkins
    depends_on:
      - backend
      - frontend
      - mongodb
    volumes:
      - ./jenkins/home:/var/jenkins_home
    ports:
      - '8080:8080'
      - '50000:50000'
    networks:
      pipe_network:
        aliases:
          - jenkins_ip

  nginx_rproxy:
    build: 
      context: ./nginx
    restart: always
    container_name: nginx_rproxy
    tty: true
    depends_on:
      - backend
    volumes:
      - ./nginx/log/:/var/log/syslog
    ports:
      - '81:80'
      - '443:443'
    networks:
      wic_network:
        aliases:
          - nginx_rproxy_ip
  
volumes:
  mongodb: {}
  jenkins: {}
  nginx: {}
  frontend: {}
  backend: {}

networks:
  wic_network:
    name: wic_net
    driver: bridge
    ipam:               #ip address management
      driver: default
  pipe_network:
    name: pipe_net
    driver: bridge
    ipam:               #ip address management
      driver: default