version: '3.7'

services:

  frontend:
    build:
      context: ./frontend
    container_name: frontend
    restart: on-failure
    depends_on:
      - nginx_rproxy
    stdin_open: true
    tty: true
    ports:
      - '3000:3000'
    networks:
      wic_frontend:
        aliases: 
          - frontend_ip

  backend:
    build:
      context: ./backend
    restart: on-failure
    depends_on:
      mongodb:
        condition: service_healthy
    container_name: backend
    init: true
    environment:
      - URL=${URL}
      - PORT=${PORT}
      - DB_NAME=${DB_NAME}
      - MONGODB_URL=${MONGODB_URL}
      - MONGODB_USER=${MONGODB_USER}
      - MONGODB_PASS=${MONGODB_PASS}
      - BACKEND_VERSION=${BACKEND_VERSION}
    networks:
      wic_backend:
        aliases: 
          - backend_ip
  nft:
    build:
      context: ./nft
    restart: on-failure
    depends_on:
      - backend
    container_name: nft
    volumes:
      - ./nft/qrs:/app/qrs
    networks:
      wic_backend:
        aliases: 
          - nft_ip

  mongodb:
    build:
      context: ./mongodb
    restart: always
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: $MONGO_ROOT_USER
      MONGO_INITDB_ROOT_PASSWORD: $MONGO_ROOT_PASS
      MONGO_INITDB_DATABASE: $DB_NAME
      MONGO_INITDB_USERNAME: $MONGODB_USER
      MONGO_INITDB_PASSWORD: $MONGODB_PASS
    volumes:
      - ./mongodb/data:/data/db
      - ./mongodb/log:/var/log/mongodb/
      - ./mongodb/mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh:ro
    networks:
      wic_backend:
        aliases: 
          - mongodb_ip


  nginx_rproxy:
    build: 
      context: ./nginx
    restart: always
    container_name: nginx_rproxy
    tty: true
    depends_on:
      - backend
    ports:
      - '81:80'
      - '443:443'
    volumes:
      - ./nginx/log/:/var/log/syslog
    networks:
      wic_backend:
        aliases:
          - nginx_rproxy_ip
      wic_frontend:
        aliases:
          - nginx_rproxy_ip
 # st-agent:
 #   image: sematext/agent:latest
 #   environment:
 #     - INFRA_TOKEN=0e8a5a78-ce62-46d0-823a-e2e9b4f95df9
 #     - SERVER_BASE_URL=https://spm-receiver.sematext.com
 #     - LOGS_RECEIVER_URL=https://logsene-receiver.sematext.com
 #     - EVENT_RECEIVER_URL=https://event-receiver.sematext.com
 #     - COMMAND_SERVER_URL=https://command.sematext.com
 #   cap_add:
 #     - SYS_ADMIN
 #   restart: always
 #   volumes:
 #     - /st-agent/:/hostfs:ro
 #     - /st-agent/etc/passwd:/etc/passwd:ro
 #     - /st-agent/etc/group:/etc/group:ro
 #     - /st-agent/var/run/:/var/run
 #     - /st-agent/sys/kernel/debug:/sys/kernel/debug
 #     - /st-agent/sys:/host/sys:ro
 #     - /st-agent/dev:/hostfs/dev:ro
 #     - /st-agent/var/run/docker.sock:/var/run/docker.sock:ro

volumes:
  mongodb: {}
  jenkins: {}
  nft: {}
#  st-agent: {}

networks:
  wic_backend:
    name: wic_net
    driver: bridge
    ipam:               #ip address management
      driver: default
  wic_frontend:
      name: wic_frontend
      driver: bridge
      ipam:               #ip address management
        driver: default